<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>📒 Mi Agenda</title>
  <!-- SDK de AppWrite -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/appwrite.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; }
    .hidden { display: none; }
    textarea { width: 100%; height: 400px; font-size: 16px; padding: 10px; }
    input, button { margin: 5px; padding: 8px; }
  </style>
</head>
<body>
  <h1>📒 Mi Agenda</h1>

  <!-- Formulario de registro y login -->
  <div id="auth">
    <h2>Registro</h2>
    <form id="signupForm">
      <input type="email" id="signupEmail" placeholder="Email" required />
      <input type="password" id="signupPassword" placeholder="Contraseña" required />
      <button type="submit">Registrarse</button>
    </form>
    <h2>Login</h2>
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" required />
      <input type="password" id="loginPassword" placeholder="Contraseña" required />
      <button type="submit">Entrar</button>
    </form>
  </div>

  <!-- Formulario de agenda -->
  <div id="agenda" style="display:none;">
    <h2>Mi Agenda</h2>
    <form id="agendaForm">
      <input type="text" id="agendaTexto" placeholder="Texto de la agenda" maxlength="255" required />
      <button type="submit">Guardar</button>
    </form>
    <ul id="agendaList"></ul>
    <button id="logoutBtn">Cerrar sesión</button>
  </div>

<script>
const appwrite = new Appwrite();
appwrite.setEndpoint('https://fra.cloud.appwrite.io/v1');
appwrite.setProject('68de5edd000689a4f63a');
const databaseId = '68de61870012fa5ed16c';
const collectionId = 'agenda'; // Si tienes el ID real de la colección, reemplázalo aquí

// Mostrar/ocultar secciones
function showAgenda() {
  document.getElementById('auth').style.display = 'none';
  document.getElementById('agenda').style.display = 'block';
}
function showAuth() {
  document.getElementById('auth').style.display = 'block';
  document.getElementById('agenda').style.display = 'none';
}

// Registro
signupForm.onsubmit = async (e) => {
  e.preventDefault();
  try {
    await appwrite.account.create(
      appwrite.ID.unique(),
      signupEmail.value,
      signupPassword.value
    );
    alert('Registro exitoso. Ahora inicia sesión.');
  } catch (err) {
    alert('Error en el registro: ' + err.message);
  }
};

// Login
loginForm.onsubmit = async (e) => {
  e.preventDefault();
  try {
    await appwrite.account.createEmailSession(
      loginEmail.value,
      loginPassword.value
    );
    // Verificar usuario autenticado
    const user = await appwrite.account.get();
    console.log('Usuario autenticado:', user);
    showAgenda();
    loadAgenda();
  } catch (err) {
    alert('Error en el login: ' + err.message);
  }
};

// Logout
logoutBtn.onclick = async () => {
  await appwrite.account.deleteSession('current');
  showAuth();
};

// Guardar agenda
agendaForm.onsubmit = async (e) => {
  e.preventDefault();
  try {
    const user = await appwrite.account.get();
    await appwrite.databases.createDocument(
      databaseId,
      collectionId,
      appwrite.ID.unique(),
      {
        userId: user.$id,
        texto: agendaTexto.value
      }
    );
    agendaTexto.value = '';
    loadAgenda();
  } catch (err) {
    alert('Error al guardar: ' + err.message);
    console.error('Error al guardar:', err);
  }
};

// Cargar agenda
async function loadAgenda() {
  agendaList.innerHTML = '';
  try {
    const user = await appwrite.account.get();
    const res = await appwrite.databases.listDocuments(
      databaseId,
      collectionId,
      [appwrite.Query.equal('userId', user.$id)]
    );
    res.documents.forEach(doc => {
      const li = document.createElement('li');
      li.textContent = doc.texto;
      agendaList.appendChild(li);
    });
  } catch (err) {
    agendaList.innerHTML = '<li>Error al cargar la agenda</li>';
    console.error('Error al cargar la agenda:', err);
  }
}

// Comprobar sesión al cargar
(async () => {
  try {
    const user = await appwrite.account.get();
    console.log('Sesión detectada:', user);
    showAgenda();
    loadAgenda();
  } catch (err) {
    showAuth();
    console.log('No hay sesión activa');
  }
})();
</script>
</body>
</html>
